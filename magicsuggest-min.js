!function(a){"use strict";var b=function(b,c){var d=this,e={allowFreeEntries:!0,cls:"",data:null,dataUrlParams:{},disabled:!1,displayField:"name",editable:!0,expanded:!1,expandOnFocus:!1,groupBy:null,hideTrigger:!1,highlight:!0,id:null,infoMsgCls:"",inputCfg:{},invalidCls:"ms-inv",matchCase:!1,maxDropHeight:290,maxEntryLength:null,maxEntryRenderer:function(a){return"Please reduce your entry by "+a+" character"+(a>1?"s":"")},maxSuggestions:null,maxSelection:10,maxSelectionRenderer:function(a){return"You cannot choose more than "+a+" item"+(a>1?"s":"")},method:"POST",minChars:0,minCharsRenderer:function(a){return"Please type "+a+" more character"+(a>1?"s":"")},mode:"local",name:null,noSuggestionText:"No suggestions",placeholder:"Type or click here",autoSelect:!0,renderer:null,required:!1,resultAsString:!1,resultsField:"results",selectionCls:"",selectionPosition:"inner",selectionRenderer:null,selectionStacked:!1,sortDir:"asc",sortOrder:null,strictSuggest:!1,style:"",toggleOnClick:!1,typeDelay:400,useTabKey:!1,useCommaKey:!0,useZebraStyle:!1,value:null,valueField:"id",vregex:null,vtype:null},f=a.extend({},c),g=a.extend(!0,{},e,f);this.addToSelection=function(b,c){if(!g.maxSelection||h.length<g.maxSelection){a.isArray(b)||(b=[b]);var e=!1;a.each(b,function(b,c){a.inArray(c[g.valueField],d.getValue())===-1&&(h.push(c),e=!0)}),e===!0&&(p._renderSelection(),this.empty(),c!==!0&&a(this).trigger("selectionchange",[this,this.getSelection()]))}this.input.attr("placeholder","inner"===g.selectionPosition&&this.getValue().length>0?"":g.placeholder)},this.clear=function(a){this.removeFromSelection(h.slice(0),a)},this.collapse=function(){g.expanded===!0&&(this.combobox.detach(),g.expanded=!1,a(this).trigger("collapse",[this]))},this.disable=function(){this.container.addClass("ms-ctn-disabled"),g.disabled=!0,d.input.attr("disabled",!0)},this.empty=function(){this.input.val("")},this.enable=function(){this.container.removeClass("ms-ctn-disabled"),g.disabled=!1,d.input.attr("disabled",!1)},this.expand=function(){!g.expanded&&(this.input.val().length>=g.minChars||this.combobox.children().size()>0)&&(this.combobox.appendTo(this.container),p._processSuggestions(),g.expanded=!0,a(this).trigger("expand",[this]))},this.isDisabled=function(){return g.disabled},this.isValid=function(){var b=g.required===!1||h.length>0;return(g.vtype||g.vregex)&&a.each(h,function(a,c){b=b&&p._validateSingleItem(c[g.displayField])}),b},this.getDataUrlParams=function(){return g.dataUrlParams},this.getName=function(){return g.name},this.getSelection=function(){return h},this.getRawValue=function(){return d.input.val()},this.getValue=function(){return a.map(h,function(a){return a[g.valueField]})},this.removeFromSelection=function(b,c){a.isArray(b)||(b=[b]);var e=!1;a.each(b,function(b,c){var f=a.inArray(c[g.valueField],d.getValue());f>-1&&(h.splice(f,1),e=!0)}),e===!0&&(p._renderSelection(),c!==!0&&a(this).trigger("selectionchange",[this,this.getSelection()]),g.expandOnFocus&&d.expand(),g.expanded&&p._processSuggestions()),this.input.attr("placeholder","inner"===g.selectionPosition&&this.getValue().length>0?"":g.placeholder)},this.getData=function(){return m},this.setData=function(a){g.data=a,p._processSuggestions()},this.setName=function(b){g.name=b,b&&(g.name+=b.indexOf("[]")>0?"":"[]"),d._valueContainer&&a.each(d._valueContainer.children(),function(a,b){b.name=g.name})},this.setSelection=function(a){this.clear(),this.addToSelection(a)},this.setValue=function(b){var c=[];a.each(b,function(b,d){var e=!1;if(a.each(m,function(a,b){if(b[g.valueField]==d)return c.push(b),e=!0,!1}),!e)if("object"==typeof d)c.push(d);else{var f={};f[g.valueField]=d,f[g.displayField]=d,c.push(f)}}),c.length>0&&this.addToSelection(c)},this.setDataUrlParams=function(b){g.dataUrlParams=a.extend({},b)};var j,h=[],i=0,k=!1,l=null,m=[],n=!1,o={BACKSPACE:8,TAB:9,ENTER:13,CTRL:17,ESC:27,SPACE:32,UPARROW:38,DOWNARROW:40,COMMA:188},p={_displaySuggestions:function(b){d.combobox.show(),d.combobox.empty();var c=0,e=0;if(null===l)p._renderComboItems(b),c=i*b.length;else{for(var f in l)e+=1,a("<div/>",{class:"ms-res-group",html:f}).appendTo(d.combobox),p._renderComboItems(l[f].items,!0);var h=d.combobox.find(".ms-res-group").outerHeight();if(null!==h){var j=e*h;c=i*b.length+j}else c=i*(b.length+e)}c<d.combobox.height()||c<=g.maxDropHeight?d.combobox.height(c):c>=d.combobox.height()&&c>g.maxDropHeight&&d.combobox.height(g.maxDropHeight),1===b.length&&g.autoSelect===!0&&d.combobox.children().filter(":last").addClass("ms-res-item-active"),0===b.length&&""!==d.getRawValue()&&(p._updateHelper(g.noSuggestionText),d.collapse()),0===b.length&&d.combobox.hide()},_getEntriesFromStringArray:function(b){var c=[];return a.each(b,function(b,d){var e={};e[g.displayField]=e[g.valueField]=a.trim(d),c.push(e)}),c},_highlightSuggestion:function(a){var b=d.input.val();return 0===b.length?a:a=g.matchCase===!0?a.replace(new RegExp("("+b+")(?!([^<]+)?>)","g"),"<em>$1</em>"):a.replace(new RegExp("("+b+")(?!([^<]+)?>)","gi"),"<em>$1</em>")},_moveSelectedRow:function(a){g.expanded||d.expand();var b,c,e,f;b=d.combobox.find(".ms-res-item"),c="down"===a?b.eq(0):b.filter(":last"),e=d.combobox.find(".ms-res-item-active:first"),e.length>0&&("down"===a?(c=e.nextAll(".ms-res-item").first(),0===c.length&&(c=b.eq(0)),f=d.combobox.scrollTop(),d.combobox.scrollTop(0),c[0].offsetTop+c.outerHeight()>d.combobox.height()&&d.combobox.scrollTop(f+i)):(c=e.prevAll(".ms-res-item").first(),0===c.length&&(c=b.filter(":last"),d.combobox.scrollTop(i*b.length)),c[0].offsetTop<d.combobox.scrollTop()&&d.combobox.scrollTop(d.combobox.scrollTop()-i))),b.removeClass("ms-res-item-active"),c.addClass("ms-res-item-active")},_processSuggestions:function(b){var c=null,e=b||g.data;if(null!==e){if("function"==typeof e&&(e=e.call(d,d.getRawValue())),"string"==typeof e){a(d).trigger("beforeload",[d]);var f=a.extend({query:d.input.val()},g.dataUrlParams);return void a.ajax({type:g.method,url:e,data:f,success:function(b){c="string"==typeof b?JSON.parse(b):b,p._processSuggestions(c),a(d).trigger("load",[d,c]),p._asyncValues&&(d.setValue("string"==typeof p._asyncValues?JSON.parse(p._asyncValues):p._asyncValues),p._renderSelection(),delete p._asyncValues)},error:function(){throw"Could not reach server"}})}m=e.length>0&&"string"==typeof e[0]?p._getEntriesFromStringArray(e):e[g.resultsField]||e;var h="remote"===g.mode?m:p._sortAndTrim(m);p._displaySuggestions(p._group(h))}},_render:function(b){switch(d.setName(g.name),d.container=a("<div/>",{class:"ms-ctn form-control "+(g.resultAsString?"ms-as-string ":"")+g.cls+(g.disabled===!0?" ms-ctn-disabled":"")+(g.editable===!0?"":" ms-ctn-readonly")+(g.hideTrigger===!1?"":" ms-no-trigger"),style:g.style,id:g.id}),d.container.focus(a.proxy(q._onFocus,this)),d.container.blur(a.proxy(q._onBlur,this)),d.container.keydown(a.proxy(q._onKeyDown,this)),d.container.keyup(a.proxy(q._onKeyUp,this)),d.input=a("<input/>",a.extend({type:"text",class:g.editable===!0?"":" ms-input-readonly",readonly:!g.editable,placeholder:g.placeholder,disabled:g.disabled},g.inputCfg)),d.input.focus(a.proxy(q._onInputFocus,this)),d.input.click(a.proxy(q._onInputClick,this)),d.combobox=a("<div/>",{class:"ms-res-ctn dropdown-menu"}).height(g.maxDropHeight),d.combobox.on("click","div.ms-res-item",a.proxy(q._onComboItemSelected,this)),d.combobox.on("mouseover","div.ms-res-item",a.proxy(q._onComboItemMouseOver,this)),d.selectionContainer=a("<div/>",{class:"ms-sel-ctn"}),d.selectionContainer.click(a.proxy(q._onFocus,this)),"inner"===g.selectionPosition?d.selectionContainer.append(d.input):d.container.append(d.input),d.helper=a("<span/>",{class:"ms-helper "+g.infoMsgCls}),p._updateHelper(),d.container.append(d.helper),a(b).replaceWith(d.container),g.selectionPosition){case"bottom":d.selectionContainer.insertAfter(d.container),g.selectionStacked===!0&&(d.selectionContainer.width(d.container.width()),d.selectionContainer.addClass("ms-stacked"));break;case"right":d.selectionContainer.insertAfter(d.container),d.container.css("float","left");break;default:d.container.append(d.selectionContainer)}g.hideTrigger===!1&&(d.trigger=a("<div/>",{class:"ms-trigger",html:'<div class="ms-trigger-ico"></div>'}),d.trigger.click(a.proxy(q._onTriggerClick,this)),d.container.append(d.trigger)),null!==g.value&&("string"==typeof g.data?(p._asyncValues=g.value,p._processSuggestions()):(p._processSuggestions(),d.setValue(g.value),p._renderSelection())),a("body").click(function(a){d.container.hasClass("ms-ctn-focus")&&0===d.container.has(a.target).length&&a.target.className.indexOf("ms-res-item")<0&&a.target.className.indexOf("ms-close-btn")<0&&d.container[0]!==a.target&&q._onBlur()}),g.expanded===!0&&(g.expanded=!1,d.expand())},_renderComboItems:function(b,c){var e=this,f="";a.each(b,function(b,d){var h=null!==g.renderer?g.renderer.call(e,d):d[g.displayField],i=a("<div/>",{class:"ms-res-item "+(c?"ms-res-item-grouped ":"")+(b%2===1&&g.useZebraStyle===!0?"ms-res-odd":""),html:g.highlight===!0?p._highlightSuggestion(h):h,"data-json":JSON.stringify(d)});i.click(a.proxy(q._onComboItemSelected,e)),i.mouseover(a.proxy(q._onComboItemMouseOver,e)),f+=a("<div/>").append(i).html()}),d.combobox.append(f),i=d.combobox.find(".ms-res-item:first").outerHeight()},_renderSelection:function(){var b=this,c=0,e=0,f=[],i=g.resultAsString===!0&&!k;d.selectionContainer.find(".ms-sel-item").remove(),void 0!==d._valueContainer&&d._valueContainer.remove(),a.each(h,function(c,d){var e,j,k=null!==g.selectionRenderer?g.selectionRenderer.call(b,d):d[g.displayField],l=p._validateSingleItem(d[g.displayField])?"":" ms-sel-invalid";i===!0?e=a("<div/>",{class:"ms-sel-item ms-sel-text "+g.selectionCls+l,html:k+(c===h.length-1?"":",")}).data("json",d):(e=a("<div/>",{class:"ms-sel-item "+g.selectionCls+l,html:k}).data("json",d),g.disabled===!1&&(j=a("<span/>",{class:"ms-close-btn"}).data("json",d).appendTo(e),j.click(a.proxy(q._onTagTriggerClick,b)))),f.push(e)}),d.selectionContainer.prepend(f),d._valueContainer=a("<div/>",{style:"display: none;"}),a.each(d.getValue(),function(b,c){var e=a("<input/>",{type:"hidden",name:g.name,value:c});e.appendTo(d._valueContainer)}),d._valueContainer.appendTo(d.selectionContainer),"inner"===g.selectionPosition&&(d.input.width(0),e=d.input.offset().left-d.selectionContainer.offset().left,c=d.container.width()-e-42,d.input.width(c)),h.length===g.maxSelection?p._updateHelper(g.maxSelectionRenderer.call(this,h.length)):d.helper.hide()},_selectItem:function(a){1===g.maxSelection&&(h=[]),d.addToSelection(a.data("json")),a.removeClass("ms-res-item-active"),g.expandOnFocus!==!1&&h.length!==g.maxSelection||d.collapse(),k?k&&(g.expandOnFocus||n)&&(p._processSuggestions(),n&&d.expand()):d.input.focus()},_sortAndTrim:function(b){var c=d.getRawValue(),e=[],f=[],h=d.getValue();return c.length>0?a.each(b,function(a,b){var d=b[g.displayField];(g.matchCase===!0&&d.indexOf(c)>-1||g.matchCase===!1&&d.toLowerCase().indexOf(c.toLowerCase())>-1)&&(g.strictSuggest!==!1&&0!==d.toLowerCase().indexOf(c.toLowerCase())||e.push(b))}):e=b,a.each(e,function(b,c){a.inArray(c[g.valueField],h)===-1&&f.push(c)}),null!==g.sortOrder&&f.sort(function(a,b){return a[g.sortOrder]<b[g.sortOrder]?"asc"===g.sortDir?-1:1:a[g.sortOrder]>b[g.sortOrder]?"asc"===g.sortDir?1:-1:0}),g.maxSuggestions&&g.maxSuggestions>0&&(f=f.slice(0,g.maxSuggestions)),f},_group:function(b){return null!==g.groupBy&&(l={},a.each(b,function(a,b){var c=g.groupBy.indexOf(".")>-1?g.groupBy.split("."):g.groupBy,d=b[g.groupBy];if("string"!=typeof c)for(d=b;c.length>0;)d=d[c.shift()];void 0===l[d]?l[d]={title:d,items:[b]}:l[d].items.push(b)})),b},_updateHelper:function(a){d.helper.html(a),d.helper.is(":visible")||d.helper.fadeIn()},_validateSingleItem:function(a){if(null!==g.vregex&&g.vregex instanceof RegExp)return g.vregex.test(a);if(null!==g.vtype)switch(g.vtype){case"alpha":return/^[a-zA-Z_]+$/.test(a);case"alphanum":return/^[a-zA-Z0-9_]+$/.test(a);case"email":return/^(\w+)([\-+.][\w]+)*@(\w[\-\w]*\.){1,5}([A-Za-z]){2,6}$/.test(a);case"url":return/(((^https?)|(^ftp)):\/\/([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i.test(a);case"ipaddress":return/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(a)}return!0}},q={_onBlur:function(){if(d.container.removeClass("ms-ctn-focus"),d.collapse(),k=!1,""!==d.getRawValue()&&g.allowFreeEntries===!0){var b={};b[g.displayField]=b[g.valueField]=d.getRawValue().trim(),d.addToSelection(b)}p._renderSelection(),d.isValid()===!1?d.container.addClass(g.invalidCls):""!==d.input.val()&&g.allowFreeEntries===!1&&(d.empty(),p._updateHelper("")),a(d).trigger("blur",[d])},_onComboItemMouseOver:function(b){d.combobox.children().removeClass("ms-res-item-active"),a(b.currentTarget).addClass("ms-res-item-active")},_onComboItemSelected:function(b){p._selectItem(a(b.currentTarget))},_onFocus:function(){d.input.focus()},_onInputClick:function(){d.isDisabled()===!1&&k&&g.toggleOnClick===!0&&(g.expanded?d.collapse():d.expand())},_onInputFocus:function(){if(d.isDisabled()===!1&&!k){k=!0,d.container.addClass("ms-ctn-focus"),d.container.removeClass(g.invalidCls);var b=d.getRawValue().length;g.expandOnFocus===!0&&d.expand(),h.length===g.maxSelection?p._updateHelper(g.maxSelectionRenderer.call(this,h.length)):b<g.minChars&&p._updateHelper(g.minCharsRenderer.call(this,g.minChars-b)),p._renderSelection(),a(d).trigger("focus",[d])}},_onKeyDown:function(b){var c=d.combobox.find(".ms-res-item-active:first"),e=d.input.val();if(a(d).trigger("keydown",[d,b]),b.keyCode===o.TAB&&(g.useTabKey===!1||g.useTabKey===!0&&0===c.length&&0===d.input.val().length))return void q._onBlur();switch(b.keyCode){case o.BACKSPACE:0===e.length&&d.getSelection().length>0&&"inner"===g.selectionPosition&&(h.pop(),p._renderSelection(),a(d).trigger("selectionchange",[d,d.getSelection()]),d.input.attr("placeholder","inner"===g.selectionPosition&&this.getValue().length>0?"":g.placeholder),d.input.focus(),b.preventDefault());break;case o.TAB:case o.ESC:case o.ENTER:b.preventDefault();break;case o.CTRL:n=!0;break;case o.DOWNARROW:b.preventDefault(),p._moveSelectedRow("down");break;case o.UPARROW:b.preventDefault(),p._moveSelectedRow("up");break;default:h.length===g.maxSelection&&b.preventDefault()}},_onKeyUp:function(b){var f,c=d.getRawValue(),e=a.trim(d.input.val()).length>0&&(!g.maxEntryLength||a.trim(d.input.val()).length<=g.maxEntryLength),i={};if(a(d).trigger("keyup",[d,b]),clearTimeout(j),b.keyCode===o.ESC&&g.expanded&&d.combobox.hide(),b.keyCode===o.TAB&&g.useTabKey===!1||b.keyCode>o.ENTER&&b.keyCode<o.SPACE)return void(b.keyCode===o.CTRL&&(n=!1));switch(b.keyCode){case o.UPARROW:case o.DOWNARROW:b.preventDefault();break;case o.ENTER:case o.TAB:case o.COMMA:if(b.keyCode!==o.COMMA||g.useCommaKey===!0){if(b.preventDefault(),g.expanded===!0&&(f=d.combobox.find(".ms-res-item-active:first"),f.length>0))return void p._selectItem(f);e===!0&&g.allowFreeEntries===!0&&(i[g.displayField]=i[g.valueField]=c.trim(),d.addToSelection(i),d.collapse(),d.input.focus());break}default:h.length===g.maxSelection?p._updateHelper(g.maxSelectionRenderer.call(this,h.length)):c.length<g.minChars?(p._updateHelper(g.minCharsRenderer.call(this,g.minChars-c.length)),g.expanded===!0&&d.collapse()):g.maxEntryLength&&c.length>g.maxEntryLength?(p._updateHelper(g.maxEntryRenderer.call(this,c.length-g.maxEntryLength)),g.expanded===!0&&d.collapse()):(d.helper.hide(),g.minChars<=c.length&&(j=setTimeout(function(){g.expanded===!0?p._processSuggestions():d.expand()},g.typeDelay)))}},_onTagTriggerClick:function(b){d.removeFromSelection(a(b.currentTarget).data("json"))},_onTriggerClick:function(){if(d.isDisabled()===!1&&(g.expandOnFocus!==!0||h.length!==g.maxSelection))if(a(d).trigger("triggerclick",[d]),g.expanded===!0)d.collapse();else{var b=d.getRawValue().length;b>=g.minChars?(d.input.focus(),d.expand()):p._updateHelper(g.minCharsRenderer.call(this,g.minChars-b))}}};null!==b&&p._render(b)};a.fn.magicSuggest=function(c){var d=a(this);return 1===d.size()&&d.data("magicSuggest")?d.data("magicSuggest"):(d.each(function(d){var e=a(this);if(!e.data("magicSuggest")){"select"===this.nodeName.toLowerCase()&&(hasData=null!=c.data,hasData||(c.data=[]),c.value=[],a.each(this.children,function(b,d){d.nodeName&&"option"===d.nodeName.toLowerCase()&&(hasData||c.data.push({id:d.value,name:d.text}),a(d).attr("selected")&&c.value.push(d.value))}));var f={};a.each(this.attributes,function(a,b){f[b.name]="value"===b.name&&""!==b.value?JSON.parse(b.value):b.value});var g=new b(this,a.extend([],a.fn.magicSuggest.defaults,c,f));e.data("magicSuggest",g),g.container.data("magicSuggest",g)}}),1===d.size()?d.data("magicSuggest"):d)},a.fn.magicSuggest.defaults={}}(jQuery);