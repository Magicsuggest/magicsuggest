/*
 MIT
 Multiple Selection Component for Bootstrap

 Author:       Nicolas Bize
 Maintainer:   Sergio F. Rodriguez
 Created:      Feb 8th 2013
 Last Updated: Feb 15, 2024
 Version:      @VERSION@
 Licence:      MagicSuggest is licenced under MIT licence (http://opensource.org/licenses/MIT)
*/
(function(d){var C=function(t,q){var b=this,y=d.extend({},q),a=d.extend(!0,{},{allowFreeEntries:!0,allowDuplicates:!1,ajaxConfig:{},ajaxJSONMode:!1,autoSelect:!0,selectFirst:!1,queryParam:"query",beforeSend:function(){},cls:"",data:null,dataUrlParams:{},disabled:!1,disabledField:null,displayField:"name",tooltipField:"title",editable:!0,expanded:!1,expandOnFocus:!1,groupBy:null,hideTrigger:!1,highlight:!0,id:null,infoMsgCls:"",inputCfg:{},invalidCls:"ms-inv",matchCase:!1,maxDropHeight:290,maxEntryLength:null,
maxEntryRenderer:function(c){return"Please reduce your entry by "+c+" character"+(1<c?"s":"")},maxSuggestions:null,maxSelection:10,maxSelectionRenderer:function(c){return"You cannot choose more than "+c+" item"+(1<c?"s":"")},method:"POST",minChars:0,minCharsRenderer:function(c){return"Please type "+c+" more character"+(1<c?"s":"")},mode:"local",name:null,noSuggestionText:"No suggestions",placeholder:"Type or click here",renderer:null,required:!1,resultAsString:!1,resultAsStringDelimiter:",",resultsField:"results",
selectionCls:"",selectionContainer:null,selectionPosition:"inner",selectionRenderer:null,selectionStacked:!1,sortDir:"asc",sortOrder:null,strictSuggest:!1,style:"",toggleOnClick:!1,typeDelay:400,useTabKey:!1,useCommaKey:!0,useZebraStyle:!1,value:null,valueField:"id",vregex:null,vtype:null},y);this.addToSelection=function(c,e){if(!a.maxSelection||k.length<a.maxSelection){Array.isArray(c)||(c=[c]);var f=!1;c.forEach(function(g){if(a.allowDuplicates||-1===d.inArray(g[a.valueField],b.getValue()))k.push(g),
f=!0});!0===f&&(h._renderSelection(),this.empty(),!0!==e&&d(this).trigger("selectionchange",[this,this.getSelection()]))}this.input.attr("placeholder","inner"===a.selectionPosition&&0<this.getValue().length?"":a.placeholder)};this.clear=function(c){this.removeFromSelection(k.slice(0),c)};this.collapse=function(){!0===a.expanded&&(this.combobox.detach(),a.expanded=!1,d(this).trigger("collapse",[this]))};this.disable=function(){this.container.addClass("ms-ctn-disabled");a.disabled=!0;b.input.attr("disabled",
!0)};this.empty=function(){this.input.val("")};this.enable=function(){this.container.removeClass("ms-ctn-disabled");a.disabled=!1;b.input.attr("disabled",!1)};this.expand=function(){!a.expanded&&(this.input.val().length>=a.minChars||0<this.combobox.children().length)&&(this.combobox.appendTo(this.container),h._processSuggestions(),a.expanded=!0,d(this).trigger("expand",[this]))};this.isDisabled=function(){return a.disabled};this.isValid=function(){var c=!1===a.required||0<k.length;(a.vtype||a.vregex)&&
k.forEach(function(e){c=c&&h._validateSingleItem(e[a.valueField])});return c};this.getDataUrlParams=function(){return a.dataUrlParams};this.getName=function(){return a.name};this.getSelection=function(){return k};this.getRawValue=function(){return this.stripHtml(b.input.val())};this.stripHtml=function(c){return c.replace(/(<([^>]+)>)/gi,"")};this.getValue=function(){return d.map(k,function(c){return c[a.valueField]})};this.removeFromSelection=function(c,e){Array.isArray(c)||(c=[c]);var f=!1;c.forEach(function(g){g=
d.inArray(g[a.valueField],b.getValue());-1<g&&(k.splice(g,1),f=!0)});!0===f&&(h._renderSelection(),!0!==e&&d(this).trigger("selectionchange",[this,this.getSelection()]),a.expandOnFocus&&b.expand(),a.expanded&&h._processSuggestions());this.input.attr("placeholder","inner"===a.selectionPosition&&0<this.getValue().length?"":a.placeholder);this.input.css({width:"100%"})};this.getData=function(){return x};this.setData=function(c){a.data=c;h._processSuggestions()};this.setName=function(c){if(a.name=c)a.name+=
0<c.indexOf("[]")?"":"[]";b._valueContainer&&d.each(b._valueContainer.children(),function(e,f){f.name=a.name})};this.setSelection=function(c){this.clear();this.addToSelection(c)};this.setValue=function(c){var e=[];d.each(c,function(f,g){var n=!1;d.each(x,function(m,r){if(r[a.valueField]==g)return e.push(r),n=!0,!1});if(!n)if("object"===typeof g)e.push(g);else{var l={};l[a.valueField]=g;l[a.displayField]=g;e.push(l)}});0<e.length&&this.addToSelection(e)};this.setDataUrlParams=function(c){a.dataUrlParams=
d.extend({},c)};this.setMaxSelection=function(c){0>c&&(c=null);null!==c&&k.length>c&&this.removeFromSelection(k.slice(c));a.maxSelection=c};var k=[],u=0,A,v=!1,w=null,x=[],z=!1,h={_displaySuggestions:function(c){b.combobox.show();b.combobox.empty();var e=0;if(null===w)h._renderComboItems(c),e=u*c.length;else{for(var f in w)e+=1,d("<div/>",{"class":"ms-res-group",html:f}).appendTo(b.combobox),h._renderComboItems(w[f].items,!0);f=b.combobox.find(".ms-res-group").outerHeight();e=null!==f?u*c.length+
e*f:u*(c.length+e)}e<b.combobox.height()||e<=a.maxDropHeight?b.combobox.height(e):e>=b.combobox.height()&&e>a.maxDropHeight&&b.combobox.height(a.maxDropHeight);1===c.length&&!0===a.autoSelect&&b.combobox.children().filter(":not(.ms-res-item-disabled):last").addClass("ms-res-item-active");!0===a.selectFirst&&b.combobox.children().filter(":not(.ms-res-item-disabled):first").addClass("ms-res-item-active");0===c.length&&""!==b.getRawValue()&&(e=a.noSuggestionText.replace(/\{\{.*\}\}/,b.input.val()),h._updateHelper(e),
b.collapse());!1===a.allowFreeEntries&&(0===c.length?(d(b.input).addClass(a.invalidCls),b.combobox.hide()):d(b.input).removeClass(a.invalidCls))},_getEntriesFromStringArray:function(c){var e=[];d.each(c,function(f,g){var n={};n[a.displayField]=n[a.valueField]=d.trim(g);e.push(n)});return e},_highlightSuggestion:function(c){var e=b.input.val();d.each("^$*+?.():!|{}[]".split(""),function(f,g){e=e.replace(g,"\\"+g)});return 0===e.length?c:c.replace(new RegExp("("+e+")(?!([^<]+)?>)",!0===a.matchCase?
"g":"gi"),"<em>$1</em>")},_moveSelectedRow:function(c){a.expanded||b.expand();var e=b.combobox.find(".ms-res-item:not(.ms-res-item-disabled)");var f="down"===c?e.eq(0):e.filter(":last");var g=b.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first");0<g.length&&("down"===c?(f=g.nextAll(".ms-res-item:not(.ms-res-item-disabled)").first(),0===f.length&&(f=e.eq(0)),c=b.combobox.scrollTop(),b.combobox.scrollTop(0),f[0].offsetTop+f.outerHeight()>b.combobox.height()&&b.combobox.scrollTop(c+
u)):(f=g.prevAll(".ms-res-item:not(.ms-res-item-disabled)").first(),0===f.length&&(f=e.filter(":last"),b.combobox.scrollTop(u*e.length)),f[0].offsetTop<b.combobox.scrollTop()&&b.combobox.scrollTop(b.combobox.scrollTop()-u)));e.removeClass("ms-res-item-active");f.addClass("ms-res-item-active")},_processSuggestions:function(c){var e=null;c=c||a.data;if(null!==c)if("function"===typeof c&&(c=c.call(b,b.getRawValue())),"string"===typeof c){d(b).trigger("beforeload",[b]);var f={};f[a.queryParam]=b.input.val();
f=d.extend(f,a.dataUrlParams);var g=!0,n="application/x-www-form-urlencoded";a.ajaxJSONMode&&(g=!1,n="application/json",f=JSON.stringify(f));d.ajax(d.extend({type:a.method,url:c,data:f,contentType:n,processData:g,beforeSend:a.beforeSend,success:function(l){e="string"===typeof l?JSON.parse(l):l;h._processSuggestions(e);d(b).trigger("load",[b,e]);h._asyncValues&&(b.setValue("string"===typeof h._asyncValues?JSON.parse(h._asyncValues):h._asyncValues),h._renderSelection(),delete h._asyncValues)},error:function(l,
m,r){d(b).trigger("error",[b,l,m,r])}},a.ajaxConfig))}else x=0<c.length&&"string"===typeof c[0]?h._getEntriesFromStringArray(c):c[a.resultsField]||c,c="remote"===a.mode?x:h._sortAndTrim(x),h._displaySuggestions(h._group(c))},_render:function(c){b.setName(a.name);b.container=d("<div/>",{"class":"ms-ctn form-control "+(a.resultAsString?"ms-as-string ":"")+a.cls+(d(c).hasClass("input-lg")?" input-lg":"")+(d(c).hasClass("input-sm")?" input-sm":"")+(!0===a.disabled?" ms-ctn-disabled":"")+(!0===a.editable?
"":" ms-ctn-readonly")+(!1===a.hideTrigger?"":" ms-no-trigger"),style:a.style,id:a.id});b.container.on("focus",d.proxy(p._onFocus,this));b.container.on("blur",d.proxy(p._onBlur,this));b.container.on("keydown",d.proxy(p._onKeyDown,this));b.container.on("keyup",d.proxy(p._onKeyUp,this));b.input=d("<input/>",d.extend({type:"text","class":!0===a.editable?"":" ms-input-readonly",readonly:!a.editable,placeholder:a.placeholder,disabled:a.disabled},a.inputCfg));b.input.on("focus",d.proxy(p._onInputFocus,
this));b.input.on("click",d.proxy(p._onInputClick,this));b.combobox=d("<div/>",{"class":"ms-res-ctn dropdown-menu"}).height(a.maxDropHeight);b.combobox.on("click","div.ms-res-item",d.proxy(p._onComboItemSelected,this));b.combobox.on("mouseover","div.ms-res-item",d.proxy(p._onComboItemMouseOver,this));a.selectionContainer?(b.selectionContainer=a.selectionContainer,d(b.selectionContainer).addClass("ms-sel-ctn")):b.selectionContainer=d("<div/>",{"class":"ms-sel-ctn"});b.selectionContainer.on("click",
d.proxy(p._onFocus,this));"inner"!==a.selectionPosition||a.selectionContainer?b.container.append(b.input):b.selectionContainer.append(b.input);b.helper=d("<span/>",{"class":"ms-helper "+a.infoMsgCls});h._updateHelper();b.container.append(b.helper);d(c).replaceWith(b.container);if(!a.selectionContainer)switch(a.selectionPosition){case "bottom":b.selectionContainer.insertAfter(b.container);!0===a.selectionStacked&&(b.selectionContainer.width(b.container.width()),b.selectionContainer.addClass("ms-stacked"));
break;case "right":b.selectionContainer.insertAfter(b.container);b.container.css("float","left");break;default:b.container.append(b.selectionContainer)}!1===a.hideTrigger&&(b.trigger=d("<div/>",{"class":"ms-trigger",html:'<div class="ms-trigger-ico"></div>'}),b.trigger.on("click",d.proxy(p._onTriggerClick,this)),b.container.append(b.trigger));d(window).on("resize",d.proxy(p._onWindowResized,this));if(null!==a.value||null!==a.data)"string"===typeof a.data?(h._asyncValues=a.value,h._processSuggestions()):
(h._processSuggestions(),null!==a.value&&(b.setValue(a.value),h._renderSelection()));d("body").on("click",function(e){var f=d(e.target).attr("class");void 0===f&&(f="");b.container.hasClass("ms-ctn-focus")&&0===b.container.has(e.target).length&&0>f.indexOf("ms-res-item")&&0>f.indexOf("ms-close-btn")&&b.container[0]!==e.target&&p._onBlur()});!0===a.expanded&&(a.expanded=!1,b.expand())},_renderComboItems:function(c,e){var f=this,g="";d.each(c,function(n,l){var m=null!==a.renderer?a.renderer.call(f,
l):l[a.displayField];m=d("<div/>",{"class":"ms-res-item "+(e?"ms-res-item-grouped ":"")+(null!==a.disabledField&&!0===l[a.disabledField]?"ms-res-item-disabled ":"")+(1===n%2&&!0===a.useZebraStyle?"ms-res-odd":""),title:null!==a.tooltipField?l[a.tooltipField]:"",html:!0===a.highlight?h._highlightSuggestion(m):m,"data-json":JSON.stringify(l)});g+=d("<div/>").append(m).html()});b.combobox.append(g);u=b.combobox.find(".ms-res-item:first").outerHeight()},_renderSelection:function(){var c=this,e=0;e=0;
var f=[],g=!0===a.resultAsString&&!v;b.selectionContainer.find(".ms-sel-item").remove();void 0!==b._valueContainer&&b._valueContainer.remove();d.each(k,function(n,l){var m=null!==a.selectionRenderer?a.selectionRenderer.call(c,l):l[a.displayField];var r=h._validateSingleItem(l[a.displayField])?"":" ms-sel-invalid";var B=null!==a.tooltipField?l[a.tooltipField]:"";!0===g?m=d("<div/>",{"class":"ms-sel-item ms-sel-text "+a.selectionCls+r,title:B,html:m+(n===k.length-1?"":a.resultAsStringDelimiter)}).data("json",
l):(m=d("<div/>",{"class":"ms-sel-item "+a.selectionCls+r,title:B,html:m}).data("json",l),!1===a.disabled&&(r=d("<span/>",{"class":"ms-close-btn"}).data("json",l).prependTo(m),r.on("click",d.proxy(p._onTagTriggerClick,c))));f.push(m)});b.selectionContainer.prepend(f);b._valueContainer=d("<div/>",{style:"display: none;"});d.each(b.getValue(),function(n,l){d("<input/>",{type:"hidden",name:a.name,value:l}).appendTo(b._valueContainer)});b._valueContainer.appendTo(b.selectionContainer);"inner"!==a.selectionPosition||
a.selectionContainer||(b.input.width(0),e=b.input.offset().left-b.selectionContainer.offset().left,e=b.container.width()-e-42,0>e&&(e=b.container.width()),b.input.width(e));k.length===a.maxSelection?h._updateHelper(a.maxSelectionRenderer.call(this,k.length)):b.helper.hide()},_selectItem:function(c){1===a.maxSelection&&(k=[]);b.addToSelection(c.data("json"));c.removeClass("ms-res-item-active");!1!==a.expandOnFocus&&k.length!==a.maxSelection||b.collapse();v?v&&(a.expandOnFocus||z)&&(h._processSuggestions(),
z&&b.expand()):b.input.trigger("focus")},_sortAndTrim:function(c){var e=b.getRawValue(),f=[],g=[],n=b.getValue();0<e.length?c.forEach(function(l){var m=l[a.displayField];(!0===a.matchCase&&-1<m.indexOf(e)||!1===a.matchCase&&-1<m.toLowerCase().indexOf(e.toLowerCase()))&&(!1===a.strictSuggest||0===m.toLowerCase().indexOf(e.toLowerCase()))&&f.push(l)}):f=c;f.forEach(function(l){(a.allowDuplicates||-1===d.inArray(l[a.valueField],n))&&g.push(l)});null!==a.sortOrder&&g.sort(function(l,m){return l[a.sortOrder]<
m[a.sortOrder]?"asc"===a.sortDir?-1:1:l[a.sortOrder]>m[a.sortOrder]?"asc"===a.sortDir?1:-1:0});a.maxSuggestions&&0<a.maxSuggestions&&(g=g.slice(0,a.maxSuggestions));return g},_group:function(c){null!==a.groupBy&&(w={},c.forEach(function(e){var f=-1<a.groupBy.indexOf(".")?a.groupBy.split("."):a.groupBy,g=e[a.groupBy];if("string"!=typeof f)for(g=e;0<f.length;)g=g[f.shift()];void 0===w[g]?w[g]={title:g,items:[e]}:w[g].items.push(e)}));return c},_updateHelper:function(c){b.helper.html(c);b.helper.is(":visible")||
b.helper.fadeIn()},_validateSingleItem:function(c){if(null!==a.vregex&&a.vregex instanceof RegExp)return a.vregex.test(c);if(null!==a.vtype)switch(a.vtype){case "alpha":return/^[a-zA-Z_]+$/.test(c);case "alphanum":return/^[a-zA-Z0-9_]+$/.test(c);case "email":return/^(\w+)([\-+.][\w]+)*@(\w[\-\w]*\.){1,5}([A-Za-z]){2,6}$/.test(c);case "url":return/(((^https?)|(^ftp)):\/\/([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i.test(c);case "ipaddress":return/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(c)}return!0}},
p={_onBlur:function(){b.container.removeClass("ms-ctn-focus");b.collapse();v=!1;if(""!==b.getRawValue()&&!0===a.allowFreeEntries){var c={};c[a.displayField]=c[a.valueField]=d.trim(b.getRawValue());b.addToSelection(c)}h._renderSelection();!1===b.isValid()?b.container.addClass(a.invalidCls):""!==b.input.val()&&!1===a.allowFreeEntries&&(b.empty(),h._updateHelper(""));d(b).trigger("blur",[b])},_onComboItemMouseOver:function(c){c=d(c.currentTarget);c.hasClass("ms-res-item-disabled")||(b.combobox.children().removeClass("ms-res-item-active"),
c.addClass("ms-res-item-active"))},_onComboItemSelected:function(c){d(c.currentTarget).hasClass("ms-res-item-disabled")||h._selectItem(d(c.currentTarget))},_onFocus:function(){b.input.trigger("focus")},_onInputClick:function(){!1===b.isDisabled()&&v&&!0===a.toggleOnClick&&(a.expanded?b.collapse():b.expand())},_onInputFocus:function(){if(!1===b.isDisabled()&&!v){v=!0;b.container.addClass("ms-ctn-focus");b.container.removeClass(a.invalidCls);var c=b.getRawValue().length;!0===a.expandOnFocus&&b.expand();
k.length===a.maxSelection?h._updateHelper(a.maxSelectionRenderer.call(this,k.length)):c<a.minChars&&h._updateHelper(a.minCharsRenderer.call(this,a.minChars-c));h._renderSelection();d(b).trigger("focus",[b])}},_onKeyDown:function(c){var e=b.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first"),f=b.input.val();d(b).trigger("keydown",[b,c]);if(9===c.keyCode&&(!1===a.useTabKey||!0===a.useTabKey&&0===e.length&&0===b.input.val().length))p._onBlur();else switch(c.keyCode){case 8:0===f.length&&
0<b.getSelection().length&&"inner"===a.selectionPosition&&(k.pop(),h._renderSelection(),d(b).trigger("selectionchange",[b,b.getSelection()]),b.input.attr("placeholder","inner"===a.selectionPosition&&0<b.getValue().length?"":a.placeholder),b.input.trigger("focus"),c.preventDefault());break;case 9:case 27:c.preventDefault();break;case 13:(""!==f||a.expanded)&&c.preventDefault();break;case 188:!0===a.useCommaKey&&c.preventDefault();break;case 17:z=!0;break;case 40:c.preventDefault();h._moveSelectedRow("down");
break;case 38:c.preventDefault();h._moveSelectedRow("up");break;default:k.length===a.maxSelection&&c.preventDefault()}},_onKeyUp:function(c){var e=b.getRawValue(),f=0<d.trim(b.input.val()).length&&(!a.maxEntryLength||d.trim(b.input.val()).length<=a.maxEntryLength),g={};d(b).trigger("keyup",[b,c]);16!==c.keyCode&&17!==c.keyCode&&clearTimeout(A);27===c.keyCode&&a.expanded&&b.combobox.hide();if(9===c.keyCode&&!1===a.useTabKey||13<c.keyCode&&32>c.keyCode)17===c.keyCode&&(z=!1);else switch(c.keyCode){case 38:case 40:c.preventDefault();
break;case 13:case 9:case 188:if(188!==c.keyCode||!0===a.useCommaKey){c.preventDefault();if(!0===a.expanded&&(c=b.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first"),0<c.length)){h._selectItem(c);break}!0===f&&!0===a.allowFreeEntries&&(g[a.displayField]=g[a.valueField]=d.trim(e),b.addToSelection(g),b.collapse(),b.input.trigger("focus"));break}default:k.length===a.maxSelection?h._updateHelper(a.maxSelectionRenderer.call(this,k.length)):e.length<a.minChars?(h._updateHelper(a.minCharsRenderer.call(this,
a.minChars-e.length)),!0===a.expanded&&b.collapse()):a.maxEntryLength&&e.length>a.maxEntryLength?(h._updateHelper(a.maxEntryRenderer.call(this,e.length-a.maxEntryLength)),!0===a.expanded&&b.collapse()):(b.helper.hide(),a.minChars<=e.length&&(A=setTimeout(function(){!0===a.expanded?h._processSuggestions():b.expand()},a.typeDelay)))}},_onTagTriggerClick:function(c){b.removeFromSelection(d(c.currentTarget).data("json"))},_onTriggerClick:function(){if(!1===b.isDisabled()&&(!0!==a.expandOnFocus||k.length!==
a.maxSelection))if(d(b).trigger("triggerclick",[b]),!0===a.expanded)b.collapse();else{var c=b.getRawValue().length;c>=a.minChars?(b.input.trigger("focus"),b.expand()):h._updateHelper(a.minCharsRenderer.call(this,a.minChars-c))}},_onWindowResized:function(){h._renderSelection()}};null!==t&&h._render(t)};d.fn.magicSuggest=function(t){var q=d(this);if(1===q.length&&q.data("magicSuggest"))return q.data("magicSuggest");q.each(function(b){b=d(this);if(!b.data("magicSuggest")){"select"===this.nodeName.toLowerCase()&&
(t.data=[],t.value=[],this.children.forEach(function(k){k.nodeName&&"option"===k.nodeName.toLowerCase()&&(t.data.push({id:k.value,name:k.text}),d(k).attr("selected")&&t.value.push(k.value))}));var y={};this.attributes.forEach(function(k){y[k.name]="value"===k.name&&""!==k.value?JSON.parse(k.value):k.value});var a=new C(this,d.extend([],d.fn.magicSuggest.defaults,t,y));b.data("magicSuggest",a);a.container.data("magicSuggest",a)}});return 1===q.length?q.data("magicSuggest"):q};d.fn.magicSuggest.defaults=
{}})(jQuery);